<!DOCTYPE html>
<html lang="ar" dir="rtl" class=""> <!-- The 'dark' class will be toggled here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Store - متجر العائلة لملابس الأطفال</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        // Set dark mode based on user preference
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // Configure Tailwind for dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Cairo', sans-serif; }
        .hero-section {
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://images.pexels.com/photos/1620760/pexels-photo-1620760.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover;
            background-position: center;
        }
        .product-card:hover, .offer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .nav-link {
             @apply text-gray-600 dark:text-gray-300 hover:text-pink-500 dark:hover:text-pink-400 transition duration-300 text-lg;
        }
        #theme-toggle svg {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200 transition-colors duration-500">

    <!-- Header Section -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-3xl font-bold text-pink-500 dark:text-pink-400" onclick="showMainPage()">Family Store</a>
            
            <div class="hidden md:flex items-center space-x-6 space-x-reverse">
                <a href="#home" class="nav-link">الرئيسية</a>
                <a href="#new-arrivals" class="nav-link">المنتجات</a>
                <a href="#offers" class="nav-link">العروض</a>
                <a href="#about" class="nav-link">من نحن</a>
            </div>

            <div class="flex items-center space-x-2 sm:space-x-4 space-x-reverse">
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>

                <!-- Cart Button -->
                <button id="cart-button" class="relative text-gray-500 dark:text-gray-400 hover:text-pink-500 dark:hover:text-pink-400 p-2.5">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-pink-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                
                <!-- Auth Buttons Container -->
                <div id="auth-container" class="flex items-center"></div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-600 dark:text-gray-300 focus:outline-none p-2.5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 bg-white dark:bg-gray-800"></div>
    </header>

    <!-- Main Page Content -->
    <div id="main-page">
        <main>
            <!-- Hero Section -->
            <section id="home" class="hero-section h-[60vh] md:h-[80vh] flex items-center justify-center text-white text-center">
                <div class="container mx-auto px-6">
                    <h1 class="text-4xl md:text-6xl font-bold mb-4 leading-tight">أناقة أطفالكم تبدأ من هنا</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-2xl mx-auto">أفضل تشكيلة من ملابس الأطفال العصرية والمريحة.</p>
                    <a href="#new-arrivals" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full transition duration-300 text-lg">
                        اكتشف الآن
                    </a>
                </div>
            </section>

            <!-- New Arrivals Section -->
            <section id="new-arrivals" class="py-16">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-10">جميع المنتجات</h2>
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                        <!-- Product cards will be dynamically inserted here -->
                    </div>
                </div>
            </section>
            
            <!-- Offers Section -->
            <section id="offers" class="py-16 bg-white dark:bg-gray-800">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-10">عروض خاصة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="offer-card bg-pink-100 dark:bg-pink-900/30 rounded-lg shadow-lg overflow-hidden flex items-center p-6 transition duration-300">
                            <div class="w-1/3">
                                <img src="https://images.pexels.com/photos/1619690/pexels-photo-1619690.jpeg?auto=compress&cs=tinysrgb&w=600" alt="Offer 1" class="rounded-lg object-cover">
                            </div>
                            <div class="w-2/3 pr-6">
                                <h3 class="font-bold text-2xl mb-2">خصم 20% على فساتين البنات</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">استفيدي من الخصم عند شراء قطعتين أو أكثر.</p>
                                <a href="#new-arrivals" class="text-pink-500 font-bold hover:underline">تسوقي الآن</a>
                            </div>
                        </div>
                        <div class="offer-card bg-blue-100 dark:bg-blue-900/30 rounded-lg shadow-lg overflow-hidden flex items-center p-6 transition duration-300">
                            <div class="w-1/3">
                                <img src="https://images.pexels.com/photos/1050244/pexels-photo-1050244.jpeg?auto=compress&cs=tinysrgb&w=600" alt="Offer 2" class="rounded-lg object-cover">
                            </div>
                            <div class="w-2/3 pr-6">
                                <h3 class="font-bold text-2xl mb-2">شحن مجاني للطلبات فوق 500 جنيه</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">تسوق براحة واستمتع بالشحن المجاني لباب بيتك.</p>
                                <a href="#new-arrivals" class="text-blue-500 font-bold hover:underline">ابدأ التسوق</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- About Us Section -->
            <section id="about" class="py-16">
                <div class="container mx-auto px-6 text-center">
                    <h2 class="text-3xl font-bold mb-4">من نحن؟</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-8 max-w-3xl mx-auto leading-relaxed">
                        في Family Store، نؤمن بأن كل طفل يستحق أن يرتدي ملابس جميلة ومريحة تعكس براءته وتضفي البهجة على أيامه. بدأنا رحلتنا بشغف كبير لنقدم لكم أفضل تشكيلة من ملابس الأطفال التي تجمع بين الجودة العالية، التصاميم العصرية، والأسعار المناسبة. نحرص على اختيار كل قطعة بعناية لتكون جزءاً من ذكريات أطفالكم السعيدة.
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- Product Detail Page (Hidden by default) -->
    <div id="product-detail-page" class="hidden"></div>

    <!-- Footer Section -->
    <footer id="contact" class="bg-gray-900 text-white pt-12">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-center md:text-right">
                <div class="md:col-span-1">
                    <h3 class="font-bold text-2xl mb-4 text-pink-400">Family Store</h3>
                    <p class="text-gray-400">ملابس أطفال لكل الأوقات.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">روابط سريعة</h3>
                    <ul>
                        <li class="mb-2"><a href="#" class="text-gray-400 hover:text-white">سياسة الخصوصية</a></li>
                        <li class="mb-2"><a href="#" class="text-gray-400 hover:text-white">شروط الاستخدام</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">تواصل معنا</h3>
                    <p class="text-gray-400 mb-2">info@familystore.com</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">تابعنا</h3>
                    <div class="flex justify-center md:justify-start space-x-4 space-x-reverse">
                        <a href="https://www.facebook.com/groups/139939095019619/" target="_blank" class="text-gray-400 hover:text-white text-2xl transition-transform transform hover:scale-110">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 py-6 text-center">
                <p class="text-gray-500">&copy; 2024 Family Store. كل الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 transform scale-95 flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold">سلة التسوق</h3>
                <button id="close-cart-button" class="text-gray-600 dark:text-gray-300 text-3xl">&times;</button>
            </div>
            <div id="cart-items" class="flex-grow overflow-y-auto mb-4"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between font-bold text-xl mb-4">
                    <span>الإجمالي:</span>
                    <span id="cart-total">0 جنيه</span>
                </div>
                <button id="whatsapp-cart-btn" class="w-full bg-green-500 text-white py-3 rounded-md mb-2 hover:bg-green-600 transition duration-300 flex items-center justify-center text-lg">
                    <i class="fab fa-whatsapp mr-2"></i> إرسال الطلب عبر واتساب
                </button>
                <button id="clear-cart-btn" class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition duration-300">
                    <i class="fas fa-trash-alt mr-2"></i> إفراغ السلة
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-8 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 id="auth-title" class="text-2xl font-bold">تسجيل الدخول</h3>
                <button id="close-auth-button" class="text-gray-600 dark:text-gray-300 text-3xl">&times;</button>
            </div>
            <div id="auth-error" class="text-red-500 text-center mb-4 h-6"></div>
            <!-- Login Form -->
            <form id="login-form">
                <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full p-3 mb-4 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                <input type="password" id="login-password" placeholder="كلمة المرور" class="w-full p-3 mb-6 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                <button type="submit" class="w-full bg-pink-500 text-white py-3 rounded-md hover:bg-pink-600">دخول</button>
                <p class="text-center mt-4">ليس لديك حساب؟ <a href="#" id="show-register" class="text-pink-500">أنشئ حسابًا جديدًا</a></p>
            </form>
            <!-- Register Form -->
            <form id="register-form" class="hidden">
                 <input type="email" id="register-email" placeholder="البريد الإلكتروني" class="w-full p-3 mb-4 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                <input type="password" id="register-password" placeholder="كلمة المرور" class="w-full p-3 mb-6 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-md hover:bg-blue-600">إنشاء حساب</button>
                <p class="text-center mt-4">لديك حساب بالفعل؟ <a href="#" id="show-login" class="text-pink-500">سجل الدخول</a></p>
            </form>
        </div>
    </div>
    
    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/201234567890" target="_blank" class="fixed bottom-5 left-5 bg-green-500 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition-transform transform hover:scale-110 z-50">
        <i class="fab fa-whatsapp fa-2x"></i>
    </a>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWissIpdbFyqclcvxCnELZOSM1UDpSTF0",
            authDomain: "familystore-b19e8.firebaseapp.com",
            projectId: "familystore-b19e8",
            storageBucket: "familystore-b19e8.appspot.com",
            messagingSenderId: "806781044278",
            appId: "1:806781044278:web:9135b67c58ceaf1b147a97"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allProducts = [];
        let cart = [];
        let currentUser = null;

        const mainPage = document.getElementById('main-page');
        const productDetailPage = document.getElementById('product-detail-page');
        const authContainer = document.getElementById('auth-container');
        const authModal = document.getElementById('auth-modal');
        const authError = document.getElementById('auth-error');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        // --- THEME TOGGLE ---
        const updateThemeIcons = () => {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                themeToggleLightIcon.classList.add('hidden');
                themeToggleDarkIcon.classList.remove('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('color-theme', 'dark');
            } else {
                localStorage.setItem('color-theme', 'light');
            }
            updateThemeIcons();
        });

        // --- MOBILE MENU ---
        function updateMobileMenu() {
            if (!mobileMenu) return;

            let authHTML = '';
            if (currentUser) {
                authHTML = `
                    <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                        <p class="py-2 text-gray-600 dark:text-gray-300">${currentUser.email}</p>
                        <a href="#" id="mobile-logout-button" class="block w-full text-left py-2 text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md px-2">تسجيل الخروج</a>
                    </div>
                `;
            } else {
                authHTML = `
                    <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                        <a href="#" id="mobile-login-button" class="block w-full text-left py-2 text-pink-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md px-2 font-bold">تسجيل الدخول</a>
                    </div>
                `;
            }

            mobileMenu.innerHTML = `
                <a href="#home" class="block py-2 nav-link rounded-md px-2 hover:bg-gray-100 dark:hover:bg-gray-700">الرئيسية</a>
                <a href="#new-arrivals" class="block py-2 nav-link rounded-md px-2 hover:bg-gray-100 dark:hover:bg-gray-700">المنتجات</a>
                <a href="#offers" class="block py-2 nav-link rounded-md px-2 hover:bg-gray-100 dark:hover:bg-gray-700">العروض</a>
                <a href="#about" class="block py-2 nav-link rounded-md px-2 hover:bg-gray-100 dark:hover:bg-gray-700">من نحن</a>
                ${authHTML}
            `;

            const mobileLoginBtn = document.getElementById('mobile-login-button');
            if (mobileLoginBtn) {
                mobileLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    authError.textContent = '';
                    authModal.classList.remove('hidden');
                    mobileMenu.classList.add('hidden');
                });
            }

            const mobileLogoutBtn = document.getElementById('mobile-logout-button');
            if (mobileLogoutBtn) {
                mobileLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    signOut(auth);
                    mobileMenu.classList.add('hidden');
                });
            }
            
            mobileMenu.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', () => {
                     mobileMenu.classList.add('hidden');
                });
            });
        }


        // --- AUTH STATE CHANGE ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                authContainer.innerHTML = `
                    <span class="hidden sm:block text-sm text-gray-600 dark:text-gray-300">${user.email}</span>
                    <button id="logout-button" class="bg-gray-200 dark:bg-gray-700 text-sm px-3 py-2 rounded-md hover:bg-gray-300 mx-2">خروج</button>
                `;
                document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
                authModal.classList.add('hidden');
                await loadCartFromFirestore();
            } else {
                authContainer.innerHTML = `
                    <button id="login-button" class="hidden sm:block bg-pink-500 text-white px-4 py-2 rounded-md hover:bg-pink-600">تسجيل الدخول</button>
                `;
                document.getElementById('login-button').addEventListener('click', () => {
                    authError.textContent = '';
                    authModal.classList.remove('hidden')
                });
                cart = [];
            }
            updateCartUI();
            updateMobileMenu(); // Update mobile menu on auth change
        });

        // --- FIRESTORE ---
        async function fetchProducts() {
            const productGrid = document.getElementById('product-grid');
            if (!productGrid) return; 
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts);
            } catch (error) {
                console.error("Error fetching products: ", error);
                productGrid.innerHTML = `<p class="text-center col-span-full text-red-500">خطأ في تحميل المنتجات. تأكد من صلاحيات قاعدة البيانات.</p>`;
            }
        }

        async function saveCartToFirestore() {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "carts", currentUser.uid), { items: cart });
            } catch (error) { console.error("Error saving cart: ", error); }
        }

        async function loadCartFromFirestore() {
            if (!currentUser) return;
            try {
                const docSnap = await getDoc(doc(db, "carts", currentUser.uid));
                cart = docSnap.exists() ? docSnap.data().items || [] : [];
                updateCartUI();
            } catch (error) { console.error("Error loading cart: ", error); }
        }

        // --- CART LOGIC ---
        window.addToCart = function(productId, selectedSize = null) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const cartItemId = selectedSize ? `${productId}_${selectedSize}` : productId;
            const existingItem = cart.find(item => item.cartId === cartItemId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1, size: selectedSize, cartId: cartItemId });
            }
            updateCartUI();
            saveCartToFirestore();
        }
        
        window.removeFromCart = function(cartItemId) {
            cart = cart.filter(item => item.cartId !== cartItemId);
            updateCartUI();
            saveCartToFirestore();
        }
        
        function clearCart() {
            cart = [];
            updateCartUI();
            saveCartToFirestore();
        }

        function sendCartViaWhatsApp() {
            if (cart.length === 0) {
                // This is better than an alert which is blocked in this environment
                console.log("Cart is empty, cannot send WhatsApp message.");
                return;
            }
            let message = "أهلاً Family Store، أود طلب المنتجات التالية:\n\n";
            let total = 0;
            cart.forEach(item => {
                const itemDisplayName = item.size ? `${item.name} (مقاس: ${item.size})` : item.name;
                message += `- ${itemDisplayName} (الكمية: ${item.quantity}) - السعر: ${item.price * item.quantity} جنيه\n`;
                total += item.price * item.quantity;
            });
            message += `\n*الإجمالي: ${total} جنيه*`;
            
            const whatsappNumber = "201234567890";
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function updateCartUI() {
            if (!cartItemsContainer || !cartTotalEl || !cartCountEl) return;
            cartItemsContainer.innerHTML = '';
            let total = 0;
            let count = 0;
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500">سلة التسوق فارغة.</p>';
            } else {
                cart.forEach(item => {
                    total += item.price * item.quantity;
                    count += item.quantity;
                    const itemDisplayName = item.size ? `${item.name} (مقاس: ${item.size})` : item.name;
                    cartItemsContainer.innerHTML += `
                        <div class="flex justify-between items-center mb-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <div class="flex-grow">
                                <span class="font-bold">${itemDisplayName}</span>
                                <span class="block text-sm text-gray-500">الكمية: ${item.quantity}</span>
                            </div>
                            <span class="font-semibold mx-4">${item.price * item.quantity} جنيه</span>
                            <button onclick="removeFromCart('${item.cartId}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                });
            }
            cartTotalEl.innerText = `${total} جنيه`;
            cartCountEl.innerText = count;
        }

        // --- RENDERING & PAGE LOGIC ---
        function renderProducts(productsToRender) {
            const productGrid = document.getElementById('product-grid');
            if (!productGrid) return;
            productGrid.innerHTML = productsToRender.map(product => {
                const description = product.description || "لا يوجد وصف متاح.";
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden product-card transition duration-300 flex flex-col cursor-pointer" onclick="showProductDetail('${product.id}')">
                        <div class="relative">
                            <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://placehold.co/400x500/cccccc/ffffff?text=No+Image'}" alt="${product.name}" class="w-full h-64 object-cover product-image">
                        </div>
                        <div class="p-6 text-center flex-grow flex flex-col">
                            <h3 class="font-bold text-xl mb-2">${product.name}</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm mb-4 flex-grow">${description.substring(0, 70)}${description.length > 70 ? '...' : ''}</p>
                            <p class="text-gray-800 dark:text-gray-200 text-lg font-bold mb-4">${product.price} جنيه</p>
                            <button onclick="event.stopPropagation(); addToCart('${product.id}')" class="mt-auto bg-pink-500 text-white px-6 py-2 rounded-md hover:bg-pink-600 w-full">أضف للسلة</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.showMainPage = function() {
            mainPage.classList.remove('hidden');
            productDetailPage.classList.add('hidden');
            productDetailPage.innerHTML = ''; // Clear content
            window.scrollTo(0, 0);
        }

        window.showProductDetail = function(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                console.error("Product not found!");
                return;
            }

            mainPage.classList.add('hidden');
            productDetailPage.classList.remove('hidden');
            window.scrollTo(0, 0);

            let sizeButtonsHTML = '';
            if (product.sizes && product.sizes.length > 0) {
                sizeButtonsHTML = product.sizes.map(size => 
                    `<button class="size-btn border-2 border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 hover:border-pink-500 dark:hover:border-pink-400 focus:border-pink-500 focus:ring-2 focus:ring-pink-300" data-size="${size}">${size}</button>`
                ).join('');
            }
            
            let thumbnailsHTML = '';
            if (product.images && product.images.length > 1) {
                thumbnailsHTML = product.images.map((imgSrc, index) => 
                    `<img src="${imgSrc}" alt="Thumbnail ${index + 1}" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-pink-500" onclick="document.getElementById('main-product-image').src='${imgSrc}'">`
                ).join('');
            }

            productDetailPage.innerHTML = `
                <div class="container mx-auto px-6 py-12">
                    <button onclick="showMainPage()" class="mb-8 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-5 py-2 rounded-full hover:bg-gray-300 transition">
                        <i class="fas fa-arrow-right ml-2"></i> العودة للمنتجات
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
                        <!-- Image Gallery -->
                        <div>
                            <div class="mb-4">
                                <img id="main-product-image" src="${product.images && product.images.length > 0 ? product.images[0] : 'https://placehold.co/600x700/cccccc/ffffff?text=No+Image'}" alt="${product.name}" class="w-full rounded-lg shadow-lg object-cover">
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                ${thumbnailsHTML}
                            </div>
                        </div>
                        <!-- Product Info -->
                        <div class="flex flex-col h-full">
                            <h1 class="text-4xl font-bold mb-4">${product.name}</h1>
                            <p class="text-gray-600 dark:text-gray-400 mb-6 text-lg flex-grow">${product.description || 'لا يوجد وصف متاح.'}</p>
                            
                            ${sizeButtonsHTML ? `
                            <div class="mb-6">
                                <h3 class="font-bold mb-3 text-lg">اختر المقاس:</h3>
                                <div id="size-selector" class="flex flex-wrap gap-3">
                                    ${sizeButtonsHTML}
                                </div>
                                <p id="size-error" class="text-red-500 mt-2 h-4"></p>
                            </div>
                            ` : ''}

                            <div class="text-3xl font-bold text-pink-500 dark:text-pink-400 mb-6">${product.price} جنيه</div>
                            
                            <button id="detail-add-to-cart-btn" class="w-full bg-pink-500 text-white py-4 px-8 rounded-lg text-lg font-bold hover:bg-pink-600 transition duration-300 mt-auto">
                                <i class="fas fa-shopping-cart mr-2"></i> أضف للسلة
                            </button>
                        </div>
                    </div>
                </div>
            `;

            let selectedSize = null;
            if (product.sizes && product.sizes.length > 0) {
                const sizeSelector = document.getElementById('size-selector');
                sizeSelector.addEventListener('click', (e) => {
                    if (e.target.classList.contains('size-btn')) {
                        sizeSelector.querySelectorAll('.size-btn').forEach(btn => {
                            btn.classList.remove('bg-pink-500', 'text-white', 'border-pink-500');
                            btn.classList.add('border-gray-300', 'dark:border-gray-600');
                        });
                        e.target.classList.add('bg-pink-500', 'text-white', 'border-pink-500');
                        e.target.classList.remove('border-gray-300', 'dark:border-gray-600');
                        selectedSize = e.target.dataset.size;
                        document.getElementById('size-error').textContent = '';
                    }
                });
            }
            
            document.getElementById('detail-add-to-cart-btn').addEventListener('click', () => {
                if (product.sizes && product.sizes.length > 0 && !selectedSize) {
                     document.getElementById('size-error').textContent = 'الرجاء اختيار مقاس أولاً.';
                     return;
                }
                addToCart(productId, selectedSize);
            });
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            updateThemeIcons();
            fetchProducts();
            updateMobileMenu(); // Initial render for mobile menu

            // Mobile menu toggle
            menuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Auth Modal Logic
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                document.getElementById('auth-title').textContent = 'إنشاء حساب جديد';
                authError.textContent = '';
            });

            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                document.getElementById('auth-title').textContent = 'تسجيل الدخول';
                authError.textContent = '';
            });
            
            document.getElementById('close-auth-button').addEventListener('click', () => authModal.classList.add('hidden'));
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => authError.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.");
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => authError.textContent = "حدث خطأ أثناء التسجيل. قد يكون البريد مستخدماً.");
            });

            // Cart Modal Logic
            document.getElementById('cart-button').addEventListener('click', () => cartModal.classList.remove('hidden'));
            document.getElementById('close-cart-button').addEventListener('click', () => cartModal.classList.add('hidden'));
            document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
            document.getElementById('whatsapp-cart-btn').addEventListener('click', sendCartViaWhatsApp);
        });
    </script>
</body>
</html>
